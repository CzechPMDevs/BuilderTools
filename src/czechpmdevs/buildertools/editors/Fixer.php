<?php

declare(strict_types=1);

/**
 * Copyright (C) 2018-2021  CzechPMDevs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

namespace czechpmdevs\buildertools\editors;

use pocketmine\utils\SingletonTrait;
use pocketmine\world\format\Chunk;
use pocketmine\world\format\SubChunk;
use pocketmine\world\World;
use function array_key_exists;
use function json_decode;

class Fixer {
	use SingletonTrait;

	// Script to generate this here: https://gist.github.com/VixikHD/5e7e1874298b548df3d190d95c0ed577
	private const BLOCK_FIX_DATA = '{"2656":1520,"3008":1361,"3024":1362,"3040":1363,"3056":1365,"3072":1364,"3088":1365,"3168":3328,"3169":3329,"3170":3331,"3171":3330,"3172":3333,"3173":3332,"3174":3334,"3175":3335,"3176":3336,"3177":3337,"3178":3338,"3179":3339,"3180":3340,"3181":3341,"3182":3342,"3183":3343,"3328":3168,"1520":3856,"1521":3857,"1522":3858,"1523":3859,"1524":3860,"1525":3861,"1526":3862,"1527":3863,"1528":3864,"1529":3865,"1530":3866,"1531":3867,"1532":3868,"1533":3869,"1534":3870,"1535":3871,"3392":3312,"4080":4032,"3184":3840,"3185":3841,"3186":3842,"3187":3843,"3188":3844,"3189":3845,"3190":3846,"3191":3847,"3192":3848,"3193":3849,"3194":3850,"3195":3851,"3196":3852,"3197":3853,"3198":3854,"3199":3855,"3360":3008,"3361":3009,"3362":3010,"3363":3011,"3364":3012,"3365":3013,"3366":3014,"3367":3015,"3368":3016,"3369":3017,"3370":3018,"3371":3019,"3372":3020,"3373":3021,"3374":3022,"3375":3023,"3376":3024,"3377":3025,"3378":3026,"3379":3027,"3380":3028,"3381":3029,"3382":3030,"3383":3031,"3384":3032,"3385":3033,"3386":3034,"3387":3035,"3388":3036,"3389":3037,"3390":3038,"3391":3039,"3488":4016,"3489":4017,"3490":4018,"3491":4019,"3492":4020,"3493":4021,"3494":4022,"3495":4023,"3496":4024,"3497":4025,"3498":4026,"3499":4027,"3500":4028,"3501":4029,"3502":4030,"3503":4031,"4016":3776,"4017":3777,"4018":3778,"4019":3779,"4020":3780,"4021":3781,"4022":3782,"4023":3783,"4024":3784,"4025":3785,"4026":3786,"4027":3787,"4028":3788,"4029":3789,"4030":3790,"4031":3791,"4032":3792,"4033":3793,"4034":3794,"4035":3795,"4036":3796,"4037":3797,"4038":3798,"4039":3799,"4040":3800,"4041":3801,"4042":3802,"4043":3803,"4044":3804,"4045":3805,"4046":3806,"4047":3807,"2016":2528,"2017":2529,"2018":2530,"2019":2531,"2020":2532,"2021":2533,"2022":2534,"2023":2535,"2024":2536,"2025":2537,"2026":2538,"2027":2539,"2028":2540,"2029":2541,"2030":2542,"2031":2543,"1536":1539,"1537":1538,"1538":1537,"1539":1536,"1540":1547,"1541":1546,"1542":1545,"1543":1544,"1544":1543,"1545":1542,"1546":1541,"1547":1540,"1548":1551,"1549":1550,"1550":1549,"1551":1548,"2672":2675,"2673":2674,"2674":2673,"2675":2672,"2676":2683,"2677":2682,"2678":2681,"2679":2680,"2680":2679,"2681":2678,"2682":2677,"2683":2676,"2684":2687,"2685":2686,"2686":2685,"2687":2684,"1232":1232,"1233":1237,"1234":1236,"1235":1235,"1236":1234,"1237":1233,"1238":1232,"1239":1247,"1240":1246,"1241":1245,"1242":1244,"1243":1243,"1244":1232,"1245":1247,"1246":1246,"1247":1245,"2288":2288,"2289":2293,"2290":2292,"2291":2291,"2292":2290,"2293":2289,"2294":2288,"2295":2303,"2296":2302,"2297":2301,"2298":2300,"2299":2299,"2300":2288,"2301":2303,"2302":2302,"2303":2301,"2512":2016,"2513":2017,"2514":2018,"2515":2019,"2516":2020,"2517":2021,"2518":2022,"2519":2023,"2520":2024,"2521":2025,"3312":3904,"3313":3905,"3314":3906,"3315":3907,"3316":3908,"3317":3909,"3318":3910,"3319":3911,"3504":[218,0],"3505":[218,0],"3506":[218,0],"3507":[218,0],"3508":[218,0],"3509":[218,0],"3510":[218,0],"3511":[218,0],"3512":[218,0],"3513":[218,0],"3514":[218,0],"3515":[218,0],"3516":[218,0],"3517":[218,0],"3518":[218,0],"3519":[218,0],"3520":[218,1],"3521":[218,1],"3522":[218,1],"3523":[218,1],"3524":[218,1],"3525":[218,1],"3526":[218,1],"3527":[218,1],"3528":[218,1],"3529":[218,1],"3530":[218,1],"3531":[218,1],"3532":[218,1],"3533":[218,1],"3534":[218,1],"3535":[218,1],"3536":[218,2],"3537":[218,2],"3538":[218,2],"3539":[218,2],"3540":[218,2],"3541":[218,2],"3542":[218,2],"3543":[218,2],"3544":[218,2],"3545":[218,2],"3546":[218,2],"3547":[218,2],"3548":[218,2],"3549":[218,2],"3550":[218,2],"3551":[218,2],"3552":[218,3],"3553":[218,3],"3554":[218,3],"3555":[218,3],"3556":[218,3],"3557":[218,3],"3558":[218,3],"3559":[218,3],"3560":[218,3],"3561":[218,3],"3562":[218,3],"3563":[218,3],"3564":[218,3],"3565":[218,3],"3566":[218,3],"3567":[218,3],"3568":[218,4],"3569":[218,4],"3570":[218,4],"3571":[218,4],"3572":[218,4],"3573":[218,4],"3574":[218,4],"3575":[218,4],"3576":[218,4],"3577":[218,4],"3578":[218,4],"3579":[218,4],"3580":[218,4],"3581":[218,4],"3582":[218,4],"3583":[218,4],"3584":[218,5],"3585":[218,5],"3586":[218,5],"3587":[218,5],"3588":[218,5],"3589":[218,5],"3590":[218,5],"3591":[218,5],"3592":[218,5],"3593":[218,5],"3594":[218,5],"3595":[218,5],"3596":[218,5],"3597":[218,5],"3598":[218,5],"3599":[218,5],"3600":[218,6],"3601":[218,6],"3602":[218,6],"3603":[218,6],"3604":[218,6],"3605":[218,6],"3606":[218,6],"3607":[218,6],"3608":[218,6],"3609":[218,6],"3610":[218,6],"3611":[218,6],"3612":[218,6],"3613":[218,6],"3614":[218,6],"3615":[218,6],"3616":[218,7],"3617":[218,7],"3618":[218,7],"3619":[218,7],"3620":[218,7],"3621":[218,7],"3622":[218,7],"3623":[218,7],"3624":[218,7],"3625":[218,7],"3626":[218,7],"3627":[218,7],"3628":[218,7],"3629":[218,7],"3630":[218,7],"3631":[218,7],"3632":[218,8],"3633":[218,8],"3634":[218,8],"3635":[218,8],"3636":[218,8],"3637":[218,8],"3638":[218,8],"3639":[218,8],"3640":[218,8],"3641":[218,8],"3642":[218,8],"3643":[218,8],"3644":[218,8],"3645":[218,8],"3646":[218,8],"3647":[218,8],"3648":[218,9],"3649":[218,9],"3650":[218,9],"3651":[218,9],"3652":[218,9],"3653":[218,9],"3654":[218,9],"3655":[218,9],"3656":[218,9],"3657":[218,9],"3658":[218,9],"3659":[218,9],"3660":[218,9],"3661":[218,9],"3662":[218,9],"3663":[218,9],"3664":[205,10],"3665":[205,10],"3666":[205,10],"3667":[205,10],"3668":[205,10],"3669":[205,10],"3670":[205,10],"3671":[205,10],"3672":[205,10],"3673":[205,10],"3674":[205,10],"3675":[205,10],"3676":[205,10],"3677":[205,10],"3678":[205,10],"3679":[205,10],"3680":[218,11],"3681":[218,11],"3682":[218,11],"3683":[218,11],"3684":[218,11],"3685":[218,11],"3686":[218,11],"3687":[218,11],"3688":[218,11],"3689":[218,11],"3690":[218,11],"3691":[218,11],"3692":[218,11],"3693":[218,11],"3694":[218,11],"3695":[218,11],"3696":[218,12],"3697":[218,12],"3698":[218,12],"3699":[218,12],"3700":[218,12],"3701":[218,12],"3702":[218,12],"3703":[218,12],"3704":[218,12],"3705":[218,12],"3706":[218,12],"3707":[218,12],"3708":[218,12],"3709":[218,12],"3710":[218,12],"3711":[218,12],"3712":[218,13],"3713":[218,13],"3714":[218,13],"3715":[218,13],"3716":[218,13],"3717":[218,13],"3718":[218,13],"3719":[218,13],"3720":[218,13],"3721":[218,13],"3722":[218,13],"3723":[218,13],"3724":[218,13],"3725":[218,13],"3726":[218,13],"3727":[218,13],"3728":[218,14],"3729":[218,14],"3730":[218,14],"3731":[218,14],"3732":[218,14],"3733":[218,14],"3734":[218,14],"3735":[218,14],"3736":[218,14],"3737":[218,14],"3738":[218,14],"3739":[218,14],"3740":[218,14],"3741":[218,14],"3742":[218,14],"3743":[218,14],"3744":[218,15],"3745":[218,15],"3746":[218,15],"3747":[218,15],"3748":[218,15],"3749":[218,15],"3750":[218,15],"3751":[218,15],"3752":[218,15],"3753":[218,15],"3754":[218,15],"3755":[218,15],"3756":[218,15],"3757":[218,15],"3758":[218,15],"3759":[218,15],"2000":2512,"2001":2513,"2002":2514,"2003":2515,"2004":2516,"2005":2517,"2528":[2000],"2529":[2001],"2530":[2002],"2531":[2003],"2532":[2004],"2533":[2005],"3232":[3218],"3236":[3222],"3240":[3226],"3264":2897,"50":3888,"466":467,"467":466,"468":469,"469":468,"496":512,"694":695,"695":694,"702":703,"703":702,"710":711,"711":710,"718":719,"719":718,"2483":2486,"2484":2490,"3280":2913,"3288":2921,"3760":3523,"3761":3524,"3762":3522,"3763":3525,"3776":3539,"3777":3540,"3778":3538,"3779":3541,"3792":3555,"3793":3556,"3794":3554,"3795":3557,"3808":3571,"3809":3572,"3810":3570,"3811":3573,"3824":3587,"3825":3588,"3826":3586,"3827":3589,"3840":3603,"3841":3604,"3842":3602,"3843":3605,"3856":3619,"3857":3620,"3858":3618,"3859":3621,"3872":3635,"3873":3636,"3874":3634,"3875":3637,"3888":3651,"3889":3652,"3890":3650,"3891":3653,"3904":3667,"3905":3668,"3906":3666,"3907":3669,"3920":3507,"3921":3508,"3922":3506,"3923":3509,"3936":3699,"3937":3700,"3938":3698,"3939":3701,"3952":3715,"3953":3716,"3954":3714,"3955":3717,"3968":3731,"3969":3732,"3970":3730,"3971":3733,"3984":3747,"3985":3748,"3986":3746,"3987":3749,"4000":3763,"4001":3764,"4002":3762,"4003":3765,"2896":2497}';
	/** @var int[] */
	private array $fullBlockFixData;

	protected function __construct() {
		/** @var int[] $fullBlockFixData */
		$fullBlockFixData = (array)json_decode(Fixer::BLOCK_FIX_DATA, true);
		$this->fullBlockFixData = $fullBlockFixData;
	}

	public function convertJavaToBedrockId(int &$fullBlock): bool {
		if(!array_key_exists($fullBlock, $this->fullBlockFixData)) {
			return false;
		}

		$fullBlock = $this->fullBlockFixData[$fullBlock];
		return true;
	}

	public function convertJavaToBedrockChunk(Chunk $chunk, int $maxY = World::Y_MAX): bool {
		$hasChanged = false;

		/** @var int|null $currentY */
		$currentY = null;
		/** @var SubChunk $subChunk */
		$subChunk = null;

		for($y = 0; $y < $maxY; ++$y) {
			if($currentY === null || $y >> SubChunk::COORD_BIT_SIZE !== $currentY) {
				$currentY = $y >> SubChunk::COORD_BIT_SIZE;
				$subChunk = $chunk->getSubChunk($y >> SubChunk::COORD_BIT_SIZE);

				if($subChunk->isEmptyFast()) {
					$y += SubChunk::EDGE_LENGTH;
					continue;
				}
			}

			for($x = 0; $x < 16; ++$x) {
				for($z = 0; $z < 16; ++$z) {
					$fullBlock = $subChunk->getFullBlock($x, $y & 0xf, $z);
					if($this->convertJavaToBedrockId($fullBlock)) {
						$subChunk->setFullBlock($x, $y & 0xf, $z, $fullBlock);

						$hasChanged = true;
					}
				}
			}
		}

		return $hasChanged;
	}
}
